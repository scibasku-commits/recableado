---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';

type Props = CollectionEntry<'blog'>['data'] & { readingTime?: number };

const { title, description, pubDate, updatedDate, heroImage, tags, readingTime } = Astro.props;

const tagStyles: Record<string, { background: string; color: string }> = {
	'üìô Memoria': { background: '#1a365d', color: 'white' },
	'üî• Ahora': { background: '#e8825c', color: 'white' },
	'üîÆ Horizonte': { background: 'linear-gradient(135deg, #1a365d, #e8825c)', color: 'white' },
	'üõ†Ô∏è Taller': { background: '#a0aec0', color: 'white' },
	'üòÇ An√©cdota': { background: '#fbd38d', color: '#2d3748' },
	'üéø Vida': { background: '#48bb78', color: 'white' },
	'‚≠ê Rese√±a': { background: '#d69e2e', color: 'white' },
};

const pageUrl = Astro.url.href;
const encodedUrl = encodeURIComponent(pageUrl);
const encodedTitle = encodeURIComponent(title);
const slug = Astro.url.pathname.replace(/^\/blog\//, '').replace(/\/$/, '');
---

<html lang="es">
	<head>
		<BaseHead title={title} description={description} ogImage={`/og/${slug}.png`} />
		<style>
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
			}
			.hero-image {
				width: 100%;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 8px;
			}
			.prose {
				width: 680px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1em;
				color: var(--text);
				line-height: 1.8;
			}
			.title {
				margin-bottom: 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
				color: var(--heading);
			}
			.date-line {
				margin-bottom: 0.6em;
				color: var(--gray);
				font-size: 0.9em;
			}
			.reading-time {
				color: var(--gray);
			}
			.last-updated-on {
				font-style: italic;
			}
			.post-tags {
				display: flex;
				justify-content: center;
				gap: 0.5em;
				flex-wrap: wrap;
				margin-bottom: 0.8em;
			}
			.post-tag {
				display: inline-flex;
				align-items: center;
				gap: 0.4rem;
				padding: 0.25rem 0.75rem;
				border-radius: 999px;
				font-family: 'Bricolage Grotesque', sans-serif;
				font-size: 0.8em;
				font-weight: 600;
				line-height: 1.4;
				white-space: nowrap;
			}

			/* Share buttons */
			.share-section {
				margin-top: 3em;
				padding-top: 2em;
				border-top: 2px solid var(--border);
				text-align: center;
			}
			.share-intro {
				font-family: 'Bricolage Grotesque', sans-serif;
				font-size: 1.1em;
				font-weight: 600;
				color: var(--heading);
				margin-bottom: 1em;
			}
			.share-buttons {
				display: flex;
				justify-content: center;
				gap: 0.8em;
				flex-wrap: wrap;
			}
			.share-btn {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				width: 48px;
				height: 48px;
				border-radius: 50%;
				background: var(--heading);
				color: white;
				text-decoration: none;
				transition: background 0.2s, transform 0.2s;
				border: none;
				cursor: pointer;
				position: relative;
			}
			.share-btn:hover {
				background: var(--naranja);
				color: white;
				transform: scale(1.1);
			}
			.share-btn svg {
				width: 20px;
				height: 20px;
				fill: currentColor;
			}
			.copy-tooltip {
				position: absolute;
				bottom: -30px;
				left: 50%;
				transform: translateX(-50%);
				background: var(--heading);
				color: white;
				padding: 3px 10px;
				border-radius: 4px;
				font-size: 0.75em;
				font-family: 'Bricolage Grotesque', sans-serif;
				white-space: nowrap;
				opacity: 0;
				transition: opacity 0.3s;
				pointer-events: none;
			}
			.copy-tooltip.show {
				opacity: 1;
			}

			/* Reactions */
			.reactions-section {
				margin-top: 2.5em;
				padding-top: 2em;
				border-top: 2px solid transparent;
				border-image: linear-gradient(to right, var(--heading), var(--naranja)) 1;
				text-align: center;
			}
			.reactions-intro {
				font-family: 'Lora', Georgia, serif;
				font-style: italic;
				font-size: 0.95em;
				color: var(--gray);
				margin-bottom: 1em;
			}
			.reactions-row {
				display: flex;
				justify-content: center;
				gap: 0.6em;
				flex-wrap: wrap;
			}
			.reaction-btn {
				display: inline-flex;
				align-items: center;
				gap: 0.4em;
				padding: 0.5em 1em;
				border-radius: 999px;
				background: var(--heading);
				color: white;
				border: 2px solid transparent;
				cursor: pointer;
				font-size: 1em;
				font-family: 'Bricolage Grotesque', sans-serif;
				transition: background 0.2s, transform 0.15s, border-color 0.2s;
			}
			.reaction-btn:hover {
				background: rgba(232, 130, 92, 0.15);
				border-color: var(--naranja);
				transform: scale(1.05);
			}
			.reaction-btn.active {
				background: var(--naranja);
				border-color: var(--naranja);
				color: white;
			}
			.reaction-btn .emoji {
				font-size: 1.2em;
				line-height: 1;
			}
			.reaction-btn .count {
				font-size: 0.85em;
				font-weight: 600;
				min-width: 1.2em;
			}
			@keyframes bounce {
				0% { transform: scale(1); }
				50% { transform: scale(1.2); }
				100% { transform: scale(1); }
			}
			.reaction-btn.bounce {
				animation: bounce 0.3s ease;
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
				<div class="hero-image">
					{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
				</div>
				<div class="prose">
					<div class="title">
						<div class="date-line">
							<FormattedDate date={pubDate} />
							{readingTime && <span class="reading-time"> ¬∑ {readingTime} min de lectura</span>}
							{
								updatedDate && (
									<div class="last-updated-on">
										Actualizado: <FormattedDate date={updatedDate} />
									</div>
								)
							}
						</div>
						{tags && tags.length > 0 && (
							<div class="post-tags">
								{tags.map((tag: string) => {
									const style = tagStyles[tag] || { background: '#a0aec0', color: 'white' };
									return (
										<span
											class="post-tag"
											style={`background: ${style.background}; color: ${style.color};`}
										>
											{tag}
										</span>
									);
								})}
							</div>
						)}
						<h1>{title}</h1>
						<hr />
					</div>
					<slot />

					<div class="share-section">
						<p class="share-intro">¬øTe ha gustado? Comp√°rtelo</p>
						<div class="share-buttons">
							<a
								class="share-btn"
								href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`}
								target="_blank"
								rel="noopener noreferrer"
								title="Compartir en LinkedIn"
							>
								<svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
							</a>
							<a
								class="share-btn"
								href={`https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`}
								target="_blank"
								rel="noopener noreferrer"
								title="Compartir en X"
							>
								<svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
							</a>
							<a
								class="share-btn"
								href={`https://wa.me/?text=${encodedTitle}%20${encodedUrl}`}
								target="_blank"
								rel="noopener noreferrer"
								title="Compartir por WhatsApp"
							>
								<svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
							</a>
							<a
								class="share-btn"
								href={`mailto:?subject=${encodedTitle}&body=${encodedUrl}`}
								title="Compartir por email"
							>
								<svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
							</a>
							<button
								class="share-btn copy-btn"
								data-url={pageUrl}
								title="Copiar enlace"
							>
								<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
								<span class="copy-tooltip">Copiado</span>
							</button>
						</div>
					</div>

					<div class="reactions-section" data-slug={slug}>
						<p class="reactions-intro">¬øQu√© te ha parecido?</p>
						<div class="reactions-row">
							<button class="reaction-btn" data-emoji="üî•">
								<span class="emoji">üî•</span>
								<span class="count">0</span>
							</button>
							<button class="reaction-btn" data-emoji="üòÇ">
								<span class="emoji">üòÇ</span>
								<span class="count">0</span>
							</button>
							<button class="reaction-btn" data-emoji="ü§Ø">
								<span class="emoji">ü§Ø</span>
								<span class="count">0</span>
							</button>
							<button class="reaction-btn" data-emoji="üí™">
								<span class="emoji">üí™</span>
								<span class="count">0</span>
							</button>
							<button class="reaction-btn" data-emoji="üß†">
								<span class="emoji">üß†</span>
								<span class="count">0</span>
							</button>
						</div>
					</div>
				</div>
			</article>
		</main>
		<Footer />
		<script>
			document.querySelectorAll('.copy-btn').forEach(btn => {
				btn.addEventListener('click', async () => {
					const url = btn.getAttribute('data-url');
					if (url) {
						await navigator.clipboard.writeText(url);
						const tooltip = btn.querySelector('.copy-tooltip');
						if (tooltip) {
							tooltip.classList.add('show');
							setTimeout(() => tooltip.classList.remove('show'), 2000);
						}
					}
				});
			});

			// Reactions
			const section = document.querySelector('.reactions-section') as HTMLElement;
			if (section) {
				const slug = section.dataset.slug!;
				const storageKey = `reactions-${slug}`;
				let voted: string[] = JSON.parse(localStorage.getItem(storageKey) || '[]');

				// Load counts
				fetch(`/api/reactions?slug=${encodeURIComponent(slug)}`)
					.then(r => r.json())
					.then(counts => {
						document.querySelectorAll('.reaction-btn').forEach(btn => {
							const emoji = (btn as HTMLElement).dataset.emoji!;
							const countEl = btn.querySelector('.count')!;
							countEl.textContent = String(counts[emoji] || 0);
							if (voted.includes(emoji)) {
								btn.classList.add('active');
							}
						});
					})
					.catch(() => {});

				// Click handler
				document.querySelectorAll('.reaction-btn').forEach(btn => {
					btn.addEventListener('click', async () => {
						const emoji = (btn as HTMLElement).dataset.emoji!;
						const isActive = btn.classList.contains('active');
						const action = isActive ? 'remove' : 'add';

						btn.classList.add('bounce');
						setTimeout(() => btn.classList.remove('bounce'), 300);

						try {
							const res = await fetch('/api/reactions', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify({ slug, emoji, action }),
							});
							const data = await res.json();
							btn.querySelector('.count')!.textContent = String(data.count);

							if (action === 'add') {
								btn.classList.add('active');
								voted.push(emoji);
							} else {
								btn.classList.remove('active');
								voted = voted.filter(e => e !== emoji);
							}
							localStorage.setItem(storageKey, JSON.stringify(voted));
						} catch {
							// silently fail
						}
					});
				});
			}
		</script>
	</body>
</html>
