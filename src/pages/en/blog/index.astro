---
export const prerender = true;
import { getCollection } from 'astro:content';
import BaseHead from '../../../components/BaseHead.astro';
import Footer from '../../../components/Footer.astro';
import FormattedDate from '../../../components/FormattedDate.astro';
import Header from '../../../components/Header.astro';
import PostStatsLoader from '../../../components/PostStatsLoader.astro';
import { SITE_TITLE } from '../../../consts';
import { useTranslations } from '../../../i18n/utils';

const lang = 'en' as const;
const t = useTranslations(lang);

// Use EN posts if available, fallback to ES
let posts = (await getCollection('blogEn')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
const usingFallback = posts.length === 0;
if (usingFallback) {
	posts = (await getCollection('blogEs')).sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);
}

const tagStyles: Record<string, { background: string; color: string; emoji: string }> = {
	'üìô Memoria': { background: '#1a365d', color: 'white', emoji: 'üìô' },
	'üî• Ahora': { background: '#e8825c', color: 'white', emoji: 'üî•' },
	'üîÆ Horizonte': { background: '#6b46c1', color: 'white', emoji: 'üîÆ' },
	'üõ†Ô∏è Taller': { background: '#a0aec0', color: 'white', emoji: 'üõ†Ô∏è' },
	'üòÇ An√©cdota': { background: '#fbd38d', color: '#2d3748', emoji: 'üòÇ' },
	'üéø Vida': { background: '#48bb78', color: 'white', emoji: 'üéø' },
	'‚≠ê Rese√±a': { background: '#d69e2e', color: 'white', emoji: '‚≠ê' },
};

function getFirstTagStyle(tags?: string[]) {
	if (!tags || tags.length === 0) return { background: '#a0aec0', color: 'white', emoji: '‚úçÔ∏è' };
	return tagStyles[tags[0]] || { background: '#a0aec0', color: 'white', emoji: '‚úçÔ∏è' };
}

const blogBase = usingFallback ? '/blog' : '/en/blog';
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Blog - ${SITE_TITLE}`} description="A 72-year-old traveller discovering the last continent" lang={lang} />
	</head>
	<body>
		<Header lang={lang} />
		<main>
			<div class="blog-header">
				<h2 class="section-title">{t('blog.allPosts') as string}</h2>
				<p class="post-count">{(t('blog.postCount') as Function)(posts.length)}</p>
			</div>

			{usingFallback && (
				<div class="fallback-banner">
					Posts are currently in Spanish. Translations coming soon.
				</div>
			)}

			<div class="post-list">
				{posts.map((post) => {
					const tagStyle = getFirstTagStyle(post.data.tags);
					const readingTime = Math.max(1, Math.ceil((post.body?.split(/\s+/).length || 0) / 200));
					const excerpt = post.data.description && post.data.description.length > 120
						? post.data.description.slice(0, 120) + '...'
						: post.data.description || '';
					return (
						<a href={`${blogBase}/${post.id}/`} class="post-card" data-slug={post.id}>
							<div class="post-thumb">
								{post.data.heroImage ? (
									<img src={post.data.heroImage} alt="" loading="lazy" />
								) : (
									<div class="post-thumb-fallback" style={`background: ${tagStyle.background};`}>
										<span class="thumb-emoji">{tagStyle.emoji}</span>
									</div>
								)}
							</div>
							<div class="post-content">
								{post.data.tags && (
									<div class="post-tags">
										{post.data.tags.map((tag: string) => {
											const style = tagStyles[tag] || { background: '#a0aec0', color: 'white', emoji: '' };
											return (
												<span class="tag" style={`background: ${style.background}; color: ${style.color};`}>
													{tag}
												</span>
											);
										})}
									</div>
								)}
								<h3 class="post-title">{post.data.title}</h3>
								<div class="post-meta">
									<FormattedDate date={post.data.pubDate} lang={lang} />
									<span>&middot; {readingTime} {t('blog.minRead') as string}</span>
									<span class="post-stats" style="display:none"></span>
								</div>
								{excerpt && <p class="post-excerpt">{excerpt}</p>}
							</div>
						</a>
					);
				})}
			</div>
		</main>
		<Footer lang={lang} />
		<PostStatsLoader />
	</body>
</html>
<style>
	.blog-header {
		margin-bottom: 2em;
	}
	.post-count {
		color: var(--gray);
		font-size: 0.9em;
		margin: -0.5em 0 0;
	}
	.fallback-banner {
		background: #fef5e7;
		border-left: 4px solid var(--naranja);
		padding: 0.8em 1.2em;
		margin-bottom: 1.5em;
		border-radius: 0 8px 8px 0;
		font-size: 0.9em;
		color: var(--text);
	}

	.post-list {
		display: flex;
		flex-direction: column;
		gap: 1.2em;
	}

	.post-card {
		display: flex;
		gap: 1.5em;
		text-decoration: none;
		padding: 1.2em;
		border-radius: 12px;
		border: 1px solid var(--border);
		background: white;
		transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
	}
	.post-card:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 16px rgba(26, 54, 93, 0.1);
		border-color: var(--naranja);
	}

	.post-thumb {
		flex-shrink: 0;
		width: 200px;
		height: 130px;
		border-radius: 8px;
		overflow: hidden;
	}
	.post-thumb img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}
	.post-thumb-fallback {
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 8px;
	}
	.thumb-emoji {
		font-size: 3em;
	}

	.post-content {
		display: flex;
		flex-direction: column;
		justify-content: center;
		min-width: 0;
	}
	.post-tags {
		display: flex;
		gap: 0.4em;
		margin-bottom: 0.4em;
		flex-wrap: wrap;
	}
	.tag {
		border-radius: 999px;
		padding: 2px 10px;
		font-size: 0.72em;
		font-family: 'Bricolage Grotesque', sans-serif;
		white-space: nowrap;
	}
	.post-title {
		font-family: 'Bricolage Grotesque', sans-serif;
		color: var(--heading);
		font-size: 1.15em;
		margin: 0 0 0.3em;
		line-height: 1.3;
		font-weight: 600;
	}
	.post-card:hover .post-title {
		color: var(--link);
	}
	.post-meta {
		font-size: 0.8em;
		color: var(--gray);
		margin-bottom: 0.4em;
	}
	.post-meta span {
		margin-left: 0.2em;
	}
	.post-excerpt {
		color: var(--text);
		font-size: 0.88em;
		margin: 0;
		line-height: 1.5;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	@media (max-width: 720px) {
		.post-card {
			flex-direction: column;
		}
		.post-thumb {
			width: 100%;
			height: 180px;
		}
	}
</style>
